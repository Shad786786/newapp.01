import streamlit as st
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta

# Replace with full Nifty 150 symbols
nifty_150_symbols = [
    'RELIANCE.NS', 'TCS.NS', 'INFY.NS', 'HDFCBANK.NS', 'ICICIBANK.NS',
    'HINDUNILVR.NS', 'ITC.NS', 'KOTAKBANK.NS', 'LT.NS', 'SBIN.NS',
    'AXISBANK.NS', 'ASIANPAINT.NS', 'HCLTECH.NS', 'BAJFINANCE.NS', 'BHARTIARTL.NS',
    'MARUTI.NS', 'SUNPHARMA.NS', 'NTPC.NS', 'ULTRACEMCO.NS', 'NESTLEIND.NS',
    'POWERGRID.NS', 'TECHM.NS', 'TITAN.NS', 'WIPRO.NS', 'JSWSTEEL.NS',
    'ONGC.NS', 'COALINDIA.NS', 'TATACONSUM.NS', 'DIVISLAB.NS', 'GRASIM.NS',
    'ADANIENT.NS', 'ADANIPORTS.NS', 'HDFC.NS', 'BAJAJFINSV.NS', 'HEROMOTOCO.NS',
    'CIPLA.NS', 'BRITANNIA.NS', 'DRREDDY.NS', 'BPCL.NS', 'EICHERMOT.NS',
    'SHREECEM.NS', 'TATAMOTORS.NS', 'SBILIFE.NS', 'ICICIGI.NS', 'APOLLOHOSP.NS',
    'BAJAJ-AUTO.NS', 'M&M.NS', 'HDFCLIFE.NS', 'INDUSINDBK.NS', 'HINDALCO.NS',
    'AUROPHARMA.NS', 'GODREJCP.NS', 'ICICIPRULI.NS', 'LTI.NS', 'UBL.NS',
    'DMART.NS', 'NMDC.NS', 'HAVELLS.NS', 'BIOCON.NS', 'PIIND.NS',
    'VEDL.NS', 'NAUKRI.NS', 'ABB.NS', 'BANDHANBNK.NS', 'YESBANK.NS',
    'IDEA.NS', 'ADANIGREEN.NS', 'BAJAJHLDNG.NS', 'BERGEPAINT.NS', 'TORNTPHARM.NS',
    'CHOLAFIN.NS', 'SRF.NS', 'GAIL.NS', 'IGL.NS', 'MUTHOOTFIN.NS',
    'PAGEIND.NS', 'PETRONET.NS', 'SIEMENS.NS', 'TVSMOTOR.NS', 'TRENT.NS',
    'COLPAL.NS', 'LUPIN.NS', 'CANBK.NS', 'BANKBARODA.NS', 'MPHASIS.NS',
    'BEL.NS', 'ZYDUSLIFE.NS', 'FEDERALBNK.NS', 'DABUR.NS', 'BOSCHLTD.NS',
    'HINDPETRO.NS', 'AMBUJACEM.NS', 'INDIGO.NS', 'ACC.NS', 'INDUSTOWER.NS',
    'IDFCFIRSTB.NS', 'LICI.NS', 'PFC.NS', 'SHRIRAMFIN.NS', 'HAL.NS',
    'CONCOR.NS', 'CUMMINSIND.NS', 'BANKINDIA.NS', 'COROMANDEL.NS', 'LTIM.NS',
    'RECLTD.NS', 'SYNGENE.NS', 'HONAUT.NS', 'JUBLFOOD.NS', 'GUJGASLTD.NS',
    'APLLTD.NS', 'AARTIIND.NS', 'IRCTC.NS', 'VOLTAS.NS', 'GLAND.NS',
    'SAIL.NS', 'NHPC.NS', 'ZOMATO.NS', 'POLYCAB.NS', 'ATGL.NS',
    'TV18BRDCST.NS', 'BHEL.NS', 'IRFC.NS', 'IEX.NS', 'DELHIVERY.NS',
    'KPITTECH.NS', 'SJVN.NS', 'NAVINFLUOR.NS', 'ABBOTINDIA.NS'
]

# Streamlit app config
st.set_page_config(page_title="Nifty 125 Stock Data", layout="centered")
st.title("üìä Nifty 125 Stock Data Fetcher")

# Mode: Single Day or Full Month
mode = st.radio("Choose Fetch Mode", ["Single Day", "Full Month"])

# Input for Single Day
if mode == "Single Day":
    option = st.selectbox("Select Date Option:", ["Today", "Yesterday", "Custom"])
    if option == "Today":
        selected_date = datetime.today().date()
    elif option == "Yesterday":
        selected_date = (datetime.today() - timedelta(days=1)).date()
    else:
        selected_date = st.date_input("Pick a custom date", max_value=datetime.today())

# Input for Full Month
if mode == "Full Month":
    year = st.selectbox("Year", list(range(2020, datetime.today().year + 1)))
    month = st.selectbox("Month", list(range(1, 13)))
    start_date = datetime(year, month, 1)
    end_date = datetime(year + (month // 12), (month % 12) + 1, 1)

# Fetch Button
# Fetch Button
if st.button("üì• Fetch Data"):
    if mode == "Single Day":
        st.info(f"Fetching Nifty 125 data for {selected_date}...")
        all_data = []

        for symbol in nifty_150_symbols:
            try:
                ticker = yf.Ticker(symbol)
                hist = ticker.history(start=selected_date, end=selected_date + timedelta(days=1), interval="1d")
                if not hist.empty:
                    row = hist.iloc[0]
                    all_data.append({
                        "Date": selected_date,
                        "Symbol": symbol.replace(".NS", ""),
                        "Open": row["Open"],
                        "High": row["High"],
                        "Low": row["Low"],
                        "Close": row["Close"],
                        "Volume": row["Volume"]
                    })
            except Exception as e:
                st.warning(f"{symbol} failed: {e}")

        if all_data:
            df = pd.DataFrame(all_data)
            st.success(f"‚úÖ Fetched {len(df)} rows.")
            st.dataframe(df)

            csv = df.to_csv(index=False).encode("utf-8")
            st.download_button("‚¨áÔ∏è Download CSV", csv, file_name=f"nifty150_{selected_date}.csv", mime="text/csv")
        else:
            st.error("‚ùå No data found.")

    # ‚¨ÖÔ∏è FIXED: this 'elif' now correctly aligns with 'if mode == "Single Day"'
    elif mode == "Full Month":
        st.info(f"Fetching full month data for: {start_date.strftime('%B %Y')}")
        full_data = []

        for symbol in nifty_150_symbols:
            try:
                ticker = yf.Ticker(symbol)
                hist = ticker.history(start=start_date, end=end_date, interval="1d")
                for index, row in hist.iterrows():
                    full_data.append({
                        "Date": index.date(),
                        "Symbol": symbol.replace(".NS", ""),
                        "Open": row["Open"],
                        "High": row["High"],
                        "Low": row["Low"],
                        "Close": row["Close"],
                        "Volume": row["Volume"]
                    })
            except Exception as e:
                st.warning(f"{symbol} failed: {e}")

        if full_data:
            df_month = pd.DataFrame(full_data)

            df_month["Date"] = pd.to_datetime(df_month["Date"], format="%Y-%m-%d")
            df_month = df_month.sort_values(by=["Date", "Symbol"], ascending=[True, True])

            st.success(f"‚úÖ Fetched {len(df_month)} rows.")
            st.dataframe(df_month.reset_index(drop=True))

            csv = df_month.to_csv(index=False).encode("utf-8")
            st.download_button(
                "‚¨áÔ∏è Download Monthly CSV",
                csv,
                file_name=f"nifty150_{year}_{month:02d}.csv",
                mime="text/csv"
            )
        else:
            st.error("‚ùå No data found for selected month.")
